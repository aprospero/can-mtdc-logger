# Sorella™ library

#### Public Header:

* ctrl/scbi_api.h

* ctrl/scbi_compat.h (optional)

#### Private implementation and header:

* ctrl/scbi.h

* ctrl/scbi.c

#### Build environment:

* std-c support for variadic functions required

* define SCBI_NO_LINUX_SUPPORT macro in non-linux environments in order to resort to the scbi_compat.h compatibility header.

* disable 'strict aliasing' compiler optimization (eg. -fno-strict-aliasing for GCC)

#### Runtime environment:

One instance of scbi for 4 sensors and 2 relays consumes 13KiByte data memory. Code size depends on build system config.

# Sorella™ API

## Quickstart

### Abstract

Sorella™ API provides a mechanism to register MTDC/LTDC device parameters for observation. 

### Procedure

Sorel MTDC/LTDC CAN bus messages are fed to Sorella™ by calling scbi_parse() for each incoming frame.

If an incoming [**scbi_frame**](#scbi_frame) reports a registered parameter and either its value has changed or a configurable period of time has elapsed since its last output, it is stored in a queue for output.

After parsing a CAN frame, repeated calls to [**scbi_pop_param**](#scbi_pop_param) provide change information on the registered parameters until the call returns an empty result.

### Configuration/Initialization

Setting up Sorella™ ready for work is divided in two phases.

* initialization of data structures and optional declaration of a log mechanism

* parameter registration

The data structures are initialized with a call to [**scbi_init**](#scbi_init). The call gets as parameters a function for memory allocation (required) and a function for handling log output (optional). In addition, the timeout is defined for which a parameter is not repeated without a value change.

Sorella™ is in some aspect configurable, eg. timeout length for reported value 

# API Reference

## Macros

#### SCBI_NO_LINUX_SUPPORT

define this macro if there is no linux support available, namely the header 

* stdint.h 

* stddef.h 

* linux/can.h

If SCBI_NO_LINUX_SUPPORT is defined the optional header file 'scbi_compat.h' is included which recreates missing definitions.

```c
#ifndef SCBI_NO_LINUX_SUPPORT
  #include <stdint.h>
  #include <stddef.h>
  #include <linux/can.h>
#else
  #include "scbi_compat.h"
#endif  // SCBI_NO_LINUX_SUPPORT
```

---

#### SCBI_MAX_SENSORS / SCBI_MAX_RELAYS

MTDC device features.

The actual values are representing the featureset of MTDCv5 - these numbers probably differ on other MTDC/LTDCs.

```c
#define SCBI_MAX_SENSORS 4
#define SCBI_MAX_RELAYS  2
```

---

#### SCBI_TIME_MAX

 [**scbi_time**](#scbi_time() max value

SCBI_TIME_MAX = 2³² = 4294967296 ms
 at this value [**scbi_time**](#scbi_time() timestamps overflow to zero.

```c
#define SCBI_TIME_MAX UINT32_MAX 
```

---

## Types

#### scbi_time

timestamp in ms

A monotonically increasing timestamp with 1ms accuracy.

Fun fact: counting to [**SCBI_TIME_MAX**](#SCBI_TIME_MAX) = 2³² = 4294967296 ms, scbi_time will overflow to zero after 49 days, 17 hours, 2 min, 47 sec and 296 ms.

```c
typedef uint32_t scbi_time;
```

---

#### struct can_frame

This structure holds a complete CAN frame.
It is defined in linux/can.h or in case of missing linux header support in scbi_compat.h

```c
struct can_frame 
{
  uint32_t can_id;  /* 32 bit CAN_ID + EFF/RTR/ERR flags */
  union {
    /* CAN frame payload length in byte (0 .. CAN_MAX_DLEN)
     * was previously named can_dlc so we need to carry that
     * name for legacy support
     */
    uint8_t len;
    uint8_t can_dlc; /* deprecated */
  } __attribute__((packed)); /* disable padding added in some ABIs */
  uint8_t __pad; /* padding */
  uint8_t __res0; /* reserved / padding */
  uint8_t len8_dlc; /* optional DLC for 8 byte payload length (9 .. 15) */
  uint8_t data[CAN_MAX_DLEN] __attribute__((aligned(8)));
};
```

---

#### struct scbi_frame

Data structure for passing SCBI messages to Sorella™ libraries parsing function.

###### Members

* [struct can_frame](#struct-can_frame) **msg** - payload consisting of a CAN bus frame

* [scbi_time](#scbi_time) timestamp associated with the frame (time of reception/generation)

```c
struct scbi_frame
{
  struct can_frame msg;   
  scbi_time        recvd; 
};
```

 ---

#### struct scbi_param

Contains data for a parameter of the MTDC/LTDC. This public API structure is the main output generated by Sorella™ library to provide a parameters value.

###### Member

* [enum scbi_param_type](#enum-scbi_param_type) **type** - the device feature type the parameter belongs to

* const char * **name**  - the name that was used upon registration.

* int32_t **value** - the actual parameter value - unit and division is defined intrinsically

```c
struct scbi_param
{
  enum scbi_param_type type;
  const char *         name;
  int32_t              value;
};
```

---

#### enum scbi_dlg_sensor_type

Used in the registration process to differentiate between available sensor types.

```c
enum scbi_dlg_sensor_type
{
  DST_UNKNOWN          = 0x00,
  DST_FLOW             = 0x01,           
  DST_RELPRESSURE      = 0x02,         
  DST_DIFFPRESSURE     = 0x03, 
  DST_TEMPERATURE      = 0x04,
  DST_HUMIDIDY         = 0x05,
  DST_ROOM_CTRL_WHEEL  = 0x06,
  DST_ROOM_CTRL_SWITCH = 0x07,
  DST_COUNT,
  DST_UNDEFINED        = 0xFF,
};
```

---

#### enum scbi_dlg_relay_mode

Used in the registration process to differentiate between available relay types.

```c
enum scbi_dlg_relay_mode 
{
  DRM_RELAYMODE_SWITCHED = 0x00,
  DRM_RELAYMODE_PHASE    = 0x01,
  DRM_RELAYMODE_PWM      = 0x02,
  DRM_RELAYMODE_VOLTAGE  = 0x03,
  DRM_COUNT
};
```

---

#### enum scbi_dlg_relay_ext_func

Used in the registration process to differentiate between available relay functions.

```c
enum scbi_dlg_relay_ext_func
{
  DRE_SOLARBYPASS         = 0x00,
  DRE_HEATING             = 0x01,
  DRE_HEATING2            = 0x02,
  DRE_COOLING             = 0x03,
  DRE_RET_FLOW_INCREASE   = 0x04,
  DRE_DISSIPATION         = 0x05,
  DRE_ANTILEGIO           = 0x06,
  DRE_REVERSE_LOADING     = 0x07,
  DRE_DIFFERENCE          = 0x08,
  DRE_WOOD_BOILER         = 0x09,

  DRE_SAFETY_FCT          = 0x0A,
  DRE_PRESSURE_CTRL       = 0x0B,
  DRE_BOOSTER             = 0x0C,
  DRE_R1PARALLEL_OP       = 0x0D,
  DRE_R2PARALLEL_OP       = 0x0E,
  DRE_ALWAYS_ON           = 0x0F,
  DRE_HEATING_CIRCUIT_RC21= 0x10,
  DRE_CIRCULATION         = 0x11,
  DRE_STORAGEHEATING      = 0x12,
  DRE_STORAGESTACKING     = 0x13,

  DRE_R_V1_PARALLEL       = 0x14,
  DRE_R_V2_PARALLEL       = 0x15,
  DRE_R1_PERMANENTLY_ON   = 0x16,
  DRE_R2_PERMANENTLY_ON   = 0x17,
  DRE_R3_PERMANENTLY_ON   = 0x18,

  DRE_V2_PERMANENTLY_ON   = 0x19,
  DRE_EXTERNALALHEATING   = 0x1A,
  DRE_NEWLOGMESSAGE       = 0x1B,

  DRE_EXTRAPUMP           = 0x1C,
  DRE_PRIMARYMIXER_UP     = 0x1D,
  DRE_PRIMARYMIXER_DOWN   = 0x1E,
  DRE_SOLAR               = 0x1F,
  DRE_CASCADE             = 0x20,

  DRE_DISABLED            = 0xFE,
  DRE_UNSELECTED          = 0xFF,
  DRE_COUNT               = DRE_CASCADE + 2 
};
```

---

#### enum scbi_dlg_overview_type

Used in the registration process for overview parameters to differentiate between available statistical values regarding yield over time.

```c
enum scbi_dlg_overview_type
{
  DOT_DAYS      = 0x01,
  DOT_WEEKS     = 0x02,
  DOT_MONTHS    = 0x03,
  DOT_YEARS     = 0x04,
  DOT_TOTAL     = 0x05,
  DOT_STATUS    = 0x06,
  DOT_UNKNOWN07 = 0x07,
  DOT_UNKNOWN08 = 0x08,
  DOT_UNKNOWN09 = 0x09,
  DOT_UNKNOWN10 = 0x0A,
  DOT_COUNT
};
```

---

#### enum scbi_dlg_overview_mode

```c
enum scbi_dlg_overview_mode
{
  DOM_00    = 0x00,  /* unknown meaning */
  DOM_01    = 0x01,
  DOM_02    = 0x02,
  DOM_COUNT
};
```

---

#### enum scbi_log_level

```c
enum scbi_log_level
{
  SCBI_LL_CRITICAL,
  SCBI_LL_ERROR,
  SCBI_LL_WARNING,
  SCBI_LL_INFO,
  SCBI_LL_DEBUG,
  SCBI_LL_CNT
};
```

---

#### struct scbi_handle

---

#### typedef alloc_fn

```c
typedef  void * (* alloc_fn) (size_t __size);
```

 ---

#### typedef log_push_fn

```c
typedef void    (* log_push_fn) (enum scbi_log_level ll, const char * format, ...);
```

---

## Functions

### Initialization



#### scbi_init

```c
struct scbi_handle * scbi_init(alloc_fn alloc, log_push_fn log_push, uint32_t repost_timeout_s);
```

 ---

#### scbi_register_sensor

```c
int scbi_register_sensor(struct scbi_handle * hnd, size_t id, enum scbi_dlg_sensor_type type, const char * entity);
```

---

#### scbi_register_relay

```c
int scbi_register_relay(struct scbi_handle * hnd, size_t id, enum scbi_dlg_relay_mode mode, enum scbi_dlg_relay_ext_func efct, const char * entity);---
```

 ---

#### scbi_register_overview

```c
int scbi_register_overview(struct scbi_handle * hnd, enum scbi_dlg_overview_type type, enum scbi_dlg_overview_mode mode, const char * entity);
```

---

#### scbi_parse

```c
int scbi_parse(struct scbi_handle * hnd, struct scbi_frame * frame);
```

---

#### scbi_peek_param

```c
struct scbi_param_public * scbi_peek_param(struct scbi_handle * hnd);
```

---

#### scbi_pop_param

```c
struct scbi_param_public * scbi_pop_param(struct scbi_handle * hnd);
```

---

#### scbi_print_frame

```c
void scbi_print_frame (struct scbi_handle * hnd, enum scbi_log_level ll, const char * msg_type, const char * txt, struct scbi_frame * frame);
```
